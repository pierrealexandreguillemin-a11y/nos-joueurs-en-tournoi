#!/usr/bin/env sh

echo "=== Pre-push quality gate ==="

echo "[1/6] TypeScript type check (ISO 5055 Reliability)..."
npx tsc --noEmit || exit 1

echo "[2/6] ESLint full project — warning budget (ISO 5055 Maintainability)..."
npx eslint src --max-warnings 0 || exit 1

echo "[3/6] Production build..."
npm run build || exit 1

echo "[4/6] Code duplication (ISO 5055 Maintainability, seuil 5%)..."
npx jscpd src --min-tokens 50 --min-lines 5 --threshold 5 --ignore "**/*.test.*,**/__tests__/**" --reporters console || exit 1

echo "[5/6] Dependency audit (OWASP A06)..."
npm audit --json 2>/dev/null | node -e "
  let d='';
  process.stdin.on('data',c=>d+=c);
  process.stdin.on('end',()=>{
    try {
      const m=JSON.parse(d)?.metadata?.vulnerabilities;
      if(!m||typeof m.critical!=='number'){console.error('npm audit: unexpected response format');process.exit(1)}
      if(m.critical>0){console.error('BLOCKED: '+m.critical+' critical vulnerabilities');process.exit(1)}
      console.log('0 critical — PASS ('+m.high+' high, '+m.moderate+' moderate)');
    } catch(e) {console.error('npm audit parse error');process.exit(1)}
  });
" || exit 1

echo "[6/6] Tests with coverage (ISO 25010 Testability)..."
npx vitest run --coverage || exit 1

echo "=== All checks passed ==="
